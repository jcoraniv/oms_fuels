<%= form_with(model: [:admin, @fuel_order], local: true, data: { controller: "nested-form" }) do |form| %>
  <% if @fuel_order.errors.any? %>
    <div id="error_explanation" class="alert alert-danger">
      <h2><%= pluralize(@fuel_order.errors.count, "error") %> prohibited this order from being saved:</h2>
      <ul>
        <% @fuel_order.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <div class="form-group mb-3">
          <%= form.label :requester_assignment_id, t('admin.fuel_orders.form.requester') %>
          <%= form.collection_select :requester_assignment_id, @assignments || [], :id, ->(a) { "#{a.personal.full_name} - #{a.position.name}" }, { prompt: t('admin.fuel_orders.form.select_requester') }, { class: 'form-control select2' } %>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <%= form.label :status, t('admin.fuel_orders.form.status') %>
          <%= form.select :status, FuelOrder.statuses.keys.map { |s| [t("admin.fuel_orders.status.#{s}"), s] }, {}, { class: 'form-control' } %>
        </div>
      </div>
      <div class="col-md-6">
        <div class="form-group mb-3">
          <%= form.label :vehicle_id, t('activerecord.attributes.fuel_order.vehicle') %>
          <%= form.collection_select :vehicle_id, @vehicles || [], :id, ->(v) { "#{v.plate} - #{v.description}" }, { prompt: t('admin.fuel_orders.form.select_vehicle') }, { class: 'form-control select2' } %>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4 mb-3">
      <h4 class="mb-0"><%= t('admin.fuel_orders.items.title') %></h4>
      <button type="button" class="btn btn-success btn-sm" id="add_item">
        <i class="bi bi-plus"></i> <%= t('admin.fuel_orders.items.add') %>
      </button>
    </div>

    <table class="table table-bordered" id="fuel-order-items">
      <thead>
        <tr>
          <th><%= t('admin.fuel_orders.items.fuel') %></th>
          <th><%= t('admin.fuel_orders.items.quantity') %></th>
          <th><%= t('admin.fuel_orders.items.unit_price') %></th>
          <th><%= t('admin.fuel_orders.items.subtotal') %></th>
          <th style="width: 100px"><%= t('common.actions') %></th>
        </tr>
      </thead>
      <tbody>
        <%= form.fields_for :fuel_order_items do |item_form| %>
          <tr class="nested-fields">
            <td>
              <%= item_form.collection_select :fuel_id, Fuel.all, :id, :description, { prompt: t('admin.fuel_orders.items.select_fuel') }, { class: 'form-control select2' } %>
            </td>
            <td>
              <%= item_form.number_field :quantity_ordered, step: 0.01, class: 'form-control item-quantity', required: true %>
            </td>
            <td>
              <%= item_form.number_field :unit_price, step: 0.01, class: 'form-control item-price', required: true %>
            </td>
            <td>
              <span class="item-subtotal">0.00</span>
            </td>
            <td>
              <%= item_form.hidden_field :_destroy %>
              <button type="button" class="btn btn-danger btn-sm remove_fields">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
        <% end %>
      </tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="text-end"><strong><%= t('admin.fuel_orders.items.total') %></strong></td>
          <td><strong id="order-total">0.00</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card-footer mt-3">
    <%= form.submit t('common.save'), class: 'btn btn-primary' %>
    <%= link_to t('common.back'), admin_fuel_orders_path, class: 'btn btn-secondary' %>
  </div>
<% end %>

<template id="item-template">
  <tr class="nested-fields">
    <td>
      <select class="form-control select2" name="fuel_order[fuel_order_items_attributes][NEW_RECORD][fuel_id]" id="fuel_order_fuel_order_items_attributes_NEW_RECORD_fuel_id"><option value="">Select a fuel</option>
<%= options_from_collection_for_select(Fuel.all, :id, :description) %></select>
    </td>
    <td>
      <input class="form-control item-quantity" step="0.01" required="required" type="number" name="fuel_order[fuel_order_items_attributes][NEW_RECORD][quantity_ordered]" id="fuel_order_fuel_order_items_attributes_NEW_RECORD_quantity_ordered">
    </td>
    <td>
      <input class="form-control item-price" step="0.01" required="required" type="number" name="fuel_order[fuel_order_items_attributes][NEW_RECORD][unit_price]" id="fuel_order_fuel_order_items_attributes_NEW_RECORD_unit_price">
    </td>
    <td>
      <span class="item-subtotal">0.00</span>
    </td>
    <td>
      <input type="hidden" name="fuel_order[fuel_order_items_attributes][NEW_RECORD][_destroy]" id="fuel_order_fuel_order_items_attributes_NEW_RECORD__destroy" value="false">
      <button type="button" class="btn btn-danger btn-sm remove_fields">
        <i class="bi bi-trash"></i>
      </button>
    </td>
  </tr>
</template>

<script>
  $(function() {
    // Calculate subtotal for a row
    function calculateSubtotal(row) {
      const quantity = parseFloat(row.find('.item-quantity').val()) || 0;
      const price = parseFloat(row.find('.item-price').val()) || 0;
      const subtotal = quantity * price;
      row.find('.item-subtotal').text(subtotal.toFixed(2));
      calculateTotal();
    }

    // Calculate total
    function calculateTotal() {
      let total = 0;
      $('#fuel-order-items tbody tr:visible').each(function() {
        const subtotal = parseFloat($(this).find('.item-subtotal').text()) || 0;
        total += subtotal;
      });
      $('#order-total').text(total.toFixed(2));
    }

    // Calculate on input change (real-time) and change (on blur)
    $('#fuel-order-items').on('input change', '.item-quantity, .item-price', function() {
      calculateSubtotal($(this).closest('tr'));
    });

    // Add Item
    $('#add_item').on('click', function(e) {
      e.preventDefault();
      const template = $('#item-template');
      const timestamp = new Date().getTime();
      let content = template.html().replace(/NEW_RECORD/g, timestamp);

      $('#fuel-order-items tbody').append(content);
      
      // Initialize select2 on new row with width 100%
      $('#fuel-order-items tbody tr:last .select2').select2({ 
        theme: 'bootstrap-5',
        width: '100%'
      });
    });

    // Remove Item
    $('#fuel-order-items').on('click', '.remove_fields', function(e) {
      e.preventDefault();
      const row = $(this).closest('tr');
      const destroyInput = row.find('input[name*="_destroy"]');

      if (destroyInput.length) {
        destroyInput.val('1');
        row.hide();
      } else {
        row.remove();
      }
      calculateTotal();
    });

    // Initial calculation for existing rows
    $('#fuel-order-items tbody tr').each(function() {
      calculateSubtotal($(this));
    });
  });
</script>